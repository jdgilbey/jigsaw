\documentclass[12pt,a4paper]{article}

\usepackage{geometry}
\geometry{%
  a4paper,
  lmargin=1.7cm,
  rmargin=1.7cm,
  tmargin=4cm,
  bmargin=2cm,
  footskip=0pt,
  headheight=2cm}

\usepackage{amsmath}
\usepackage{amssymb}
\let\ge=\geqslant  \let\le=\leqslant
\usepackage{calc}
\usepackage{tikz}[2013/12/13 v3.0.0]
\usetikzlibrary{calc}
\tikzset{above/.default=6pt}
\tikzset{regular/.style={}}
\tikzset{hidden/.style={fill=yellow!80!white}}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead{}
\fancyfoot{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\usepackage{lastpage}

\newsavebox\templateimagebox
\newdimen\templateimagewd
\newif\iftesting  % say \testingtrue to have \numberedcard etc. use
                  % simple parameters like {Q1} instead of {{regular}{Q1}}

\usepackage[export]{adjustbox}

\newcommand{\image}[1]{\includegraphics[max height=0.8\cardht, max width=0.8\cardwd]{#1}}
% There might be a nicer way to do the following, but I haven't yet
% found it.
\newcommand{\imagecap}[2]{%
  \savebox{\templateimagebox}{\includegraphics[max height=0.8\cardht, max width=0.8\cardwd]{#1}}%
  \setlength{\templateimagewd}{\wd\templateimagebox}%
  \hbox to \templateimagewd{%
    \begin{minipage}{\templateimagewd}%
      \usebox{\templateimagebox}\\
      \hbox to \templateimagewd{\hss #2\hss}%
    \end{minipage}}}

\newcommand{\makestyles}[3]{%
  \iftesting
    \def#1{regular}
    \def#2{#3}
  \else
    % split #3 into {style}{text}
    \makestylesa#1#2#3
  \fi
}
\newcommand{\makestylesa}[4]{%
  \def#1{#3}
  \def#2{#4}
}

\newdimen\cardwd
\newdimen\cardht
\newdimen\cardtxtwd
\newdimen\offset
\setlength\offset{6mm}

% Card number #3 appears on row #1 column #2 with content #4 and label #5
% Top left is (0,0) in our drawing
\newcommand{\numberedcard}[5]{%
  \coordinate (topl) at ($ (#2*\cardwd-\cardwd, \cardht-#1*\cardht) $);
  \coordinate (botr) at ($ (#2*\cardwd, -#1*\cardht) $);
  \coordinate (botl) at (topl |- botr);
  \coordinate (topr) at (topl -| botr);

  \makestyles\style\content{#4}

  \draw (topl) rectangle (botr);
  \node[text width=\cardtxtwd,align=flush center,\style] at
     ($ (topl)!0.5!(botr) $) {\content\par};
  \node[circle,draw,thin,inner sep=1pt]
     at ($ (topl)!0.5!(botl) + (\offset,0) $) {#3};

  \def\templabel{#5}
  \ifx\templabel\empty
  \else \node at ($ (botl)!0.5!(botr) + (0,\offset) $) {\templabel};
  \fi
  \ifx\cardtitle\empty
  \else \node at ($ (topl)!0.5!(topr) + (0,-\offset) $) {\cardtitle};
  \fi
}

\newcommand{\unnumberedcard}[5]{%
  \coordinate (topl) at ($ (#2*\cardwd-\cardwd, \cardht-#1*\cardht) $);
  \coordinate (botr) at ($ (#2*\cardwd, -#1*\cardht) $);
  \coordinate (botl) at (topl |- botr);
  \coordinate (topr) at (topl -| botr);

  \makestyles\style\content{#4}

  \draw (topl) rectangle (botr);
  \node[text width=\cardtxtwd,align=flush center,\style] at
     ($ (topl)!0.5!(botr) $) {\content\par};

  \def\templabel{#5}
  \ifx\templabel\empty
  \else \node at ($ (botl)!0.5!(botr) + (0,\offset) $) {\templabel};
  \fi
  \ifx\cardtitle\empty
  \else \node at ($ (topl)!0.5!(topr) + (0,-\offset) $) {\cardtitle};
  \fi
}

\setlength{\parindent}{0pt}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 
