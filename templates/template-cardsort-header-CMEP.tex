\documentclass[12pt,a4paper]{article}

\usepackage{geometry}
\geometry{%
  a4paper,
  lmargin=1.7cm,
  rmargin=1.7cm,
  tmargin=4cm,
  bmargin=2cm,
  footskip=24pt,
  headheight=2cm}

\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead{}
\fancyfoot{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\usepackage{lastpage}

\usepackage{amsmath}
\usepackage{amssymb}
\let\ge=\geqslant  \let\le=\leqslant
\usepackage{calc}
\usepackage{tikz}[2013/12/13 v3.0.0]
\usetikzlibrary{calc}
\usetikzlibrary{positioning}

%%% CMEP Specific stuff; some may well be redundant

%%% HEADERS
\usepackage{xcolor}

%% Define styles used in the headers
\definecolor{headertextcol}{HTML}{000000}
\newcommand*{\headerlogofont}{\small\color{headertextcol}}
\newcommand*{\footerfont}{\scriptsize}
\newcommand*{\logoheight}{10pt}

%% Define the footers
\fancyfoot[L]{%
  $\vcenter{\hbox{\includegraphics[height=\logoheight]{cmep-logo3}}}$
  \footerfont Cambridge Mathematics Education Project
}

\fancyfoot[R]{%
  \footerfont\copyright{} University of Cambridge unless indicated otherwise. All rights reserved.%
}

%%% FONTS
\usepackage{fontspec}
% Uncomment next two lines for Helvetica Neue font
\setmainfont[Ligatures=TeX]{Helvetica Neue}
\setsansfont[Ligatures=TeX]{Helvetica Neue}

\setmonofont[Scale=MatchLowercase]{Monaco}

\newfontfamily\ChalkFont[Path=./,Scale=MatchLowercase]{Delius-Regular.ttf}
\usepackage{fontawesome}

%%% MATHEMATICS
\usepackage{mathtools}
\usepackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
\setmathfont[Scale=MatchLowercase]{XITS Math}

% This overwrites the \includegraphics command to search for just a
% png and a pdf image, and the png image is by default scaled at
% scale=0.25 is designed so that a 1500px image at the pdftex default
% of 72dpi fits in about 14cm = 21cm width - two 3.5cm margins.
% 
% Testing for the existence of a file which might have spaces in the
% filename is ugly.  See
% http://compgroups.net/comp.text.tex/-iffileexists/1936440 for a
% discussion of this point.  So don't use spaces in filenames!
\usepackage{pdftexcmds}
\usepackage[export]{adjustbox}
\let\Oldincludegraphics\includegraphics
\makeatletter
\renewcommand{\includegraphics}[2][]{%
  \if\relax\pdf@filesize{#2.pdf}\relax
    % does not exist
    \Oldincludegraphics[scale=0.25,#1]{#2.png}%
  \else
    % does exist
    \Oldincludegraphics[#1]{#2.pdf}
  \fi
  }
\makeatother

%%% FRAMES
\usepackage[xcolor,framemethod=TikZ,suppressfirstparskip=false]{mdframed}

% WELL
\definecolor{wellbackground}{HTML}{F5F5F5} 
\definecolor{wellborder}{HTML}{E3E3E3}
\global\mdfdefinestyle{well}{%
backgroundcolor=wellbackground,%
linecolor=wellborder,%
middlelinewidth=1pt,%
innertopmargin=20pt,%
innerbottommargin=20pt,%
nobreak=false,%
roundcorner=4pt%
}


% QWELL
\definecolor{qwellbackground}{HTML}{F0FAFF}% was {FFF1DF} 
\definecolor{qwellborder}{HTML}{E3E3E3}
\global\mdfdefinestyle{qwell}{%
backgroundcolor=qwellbackground,%
linecolor=qwellborder,%
middlelinewidth=1pt,%
innertopmargin=10pt,%
innerbottommargin=10pt,%
innerleftmargin=5pt,%
innerrightmargin=5pt,%
nobreak=false,%
roundcorner=4pt%
}

% CHALK
\definecolor{chalkbackground}{HTML}{FFFFFF}
\definecolor{chalkborder}{HTML}{0088CC}
\global\mdfdefinestyle{chalk}{%
backgroundcolor=chalkbackground,%
middlelinewidth=3pt,% weirdly the middle line is drawn underneath the dashed one added below
middlelinecolor=white,% but if it's removed the dashed one goes too...
roundcorner=20pt,%
nobreak=false,%
innertopmargin=20pt,%
innerbottommargin=20pt,%
font=\ChalkFont,%
fontcolor=chalkborder,%
tikzsetting={draw=chalkborder,dashed,line width=3pt,dash pattern = on 3pt off 3pt}%
}

\newcommand{\vect}[1]{\mathbf{#1}}      % choose a vector display style
\newcommand{\intersect}{\cap}
\newcommand{\union}{\cup}
\newcommand{\containing}{\supset}
\renewcommand\Re{\operatorname{Re}}
\renewcommand\Im{\operatorname{Im}}
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
\DeclarePairedDelimiter\norm{\lVert}{\rVert}

\DeclareMathOperator{\Var}{Var}
\DeclareMathOperator{\Cov}{Cov}
\DeclareMathOperator{\E}{E}
\DeclareMathOperator{\cosec}{cosec}
\DeclareMathOperator{\sech}{sech}
\DeclareMathOperator{\cosech}{cosech}
\DeclareMathOperator{\cotanh}{cotanh}
\DeclareMathOperator{\arsinh}{arsinh}
\DeclareMathOperator{\arcosh}{arcosh}
\DeclareMathOperator{\artanh}{artanh}
\newcommand{\quantity}[2]{{#1}\,\mathrm{#2}}
%%% End CMEP Specific stuff

\tikzset{above/.default=6pt}
\tikzset{regular/.style={}}
\tikzset{hidden/.style={fill=yellow!80!white}}

\newsavebox\templateimagebox
\newdimen\templateimagewd
\newif\iftesting  % say \testingtrue to have \card use simple
                  % parameters like {Q1} instead of {{regular}{Q1}}

\usepackage[export]{adjustbox}

\newcommand{\image}[1]{\includegraphics[max height=0.8\cardht, max width=0.8\cardwd]{#1}}
% There might be a nicer way to do the following, but I haven't yet
% found it.
\newcommand{\imagecap}[2]{%
  \savebox{\templateimagebox}{\includegraphics[max height=0.8\cardht, max width=0.8\cardwd]{#1}}%
  \setlength{\templateimagewd}{\wd\templateimagebox}%
  \hbox to \templateimagewd{%
    \begin{minipage}{\templateimagewd}%
      \usebox{\templateimagebox}\\
      \hbox to \templateimagewd{\hss #2\hss}%
    \end{minipage}}}

\newcommand{\makestyles}[3]{%
  \iftesting
    \def#1{regular}
    \def#2{#3}
  \else
    % split #3 into {style}{text}
    \makestylesa#1#2#3
  \fi
}
\newcommand{\makestylesa}[4]{%
  \def#1{#3}
  \def#2{#4}
}

% How much space should there be around the cards?
% The gap between cards is twice this amount
% This is zero by default, but can be modified by
% users of this header.
\newdimen\cardseph \setlength\cardseph{0pt}
\newdimen\cardsepv \setlength\cardsepv{0pt}
\newdimen\cardwd
\newdimen\cardht
\newdimen\cardtxtwd
\newdimen\offset
\setlength{\offset}{6mm}
\setlength{\cardwd}{3cm}  % defaults so table output works
\setlength{\cardht}{2cm}

% Card number #3 appears on row #1 column #2 with content #4 and label #5
% If card number is empty, don't draw circle around number
% Top left is (0,0) in our drawing
\newcommand{\card}[5]{%
  \coordinate (topl) at ($ (#2*\cardwd-\cardwd+\cardseph, \cardht-#1*\cardht-\cardsepv) $);
  \coordinate (botr) at ($ (#2*\cardwd-\cardseph, -#1*\cardht+\cardsepv) $);
  \coordinate (botl) at (topl |- botr);
  \coordinate (topr) at (topl -| botr);

  \makestyles\style\content{#4}

  \draw (topl) rectangle (botr);
  \node[text width=\cardtxtwd,align=flush center,\style] at
     ($ (topl)!0.5!(botr) $) {\content\par};
  \def\templabel{#3}
  \ifx\templabel\empty
  \else
    \node[circle,draw,thin,inner sep=1pt]
      at ($ (topl) + (\offset,-\offset) $) {#3};
  \fi

  \def\templabel{#5}
  \ifx\templabel\empty
  \else \node at ($ (botl)!0.5!(botr) + (0,\offset) $) {\templabel};
  \fi
  \ifx\cardtitle\empty
  \else \node at ($ (topl)!0.5!(topr) + (0,-\offset) $) {\cardtitle};
  \fi
}

% This is identical to \card, except that it's intended for double-sided
% cards, so it doesn't draw a border.
\newcommand{\borderlesscard}[5]{%
  \coordinate (topl) at ($ (#2*\cardwd-\cardwd+\cardseph, \cardht-#1*\cardht-\cardsepv) $);
  \coordinate (botr) at ($ (#2*\cardwd-\cardseph, -#1*\cardht+\cardsepv) $);
  \coordinate (botl) at (topl |- botr);
  \coordinate (topr) at (topl -| botr);

  \makestyles\style\content{#4}

  \node[text width=\cardtxtwd,align=flush center,\style] at
     ($ (topl)!0.5!(botr) $) {\content\par};
  \def\templabel{#3}
  \ifx\templabel\empty
  \else
    \node[circle,draw,thin,inner sep=1pt]
      at ($ (topl) + (\offset,-\offset) $) {#3};
  \fi

  \def\templabel{#5}
  \ifx\templabel\empty
  \else \node at ($ (botl)!0.5!(botr) + (0,\offset) $) {\templabel};
  \fi
  \ifx\cardtitle\empty
  \else \node at ($ (topl)!0.5!(topr) + (0,-\offset) $) {\cardtitle};
  \fi
}

% Domino number #3 appears on row #1 column #2 with left content #4,
% right content #5
% If card number is empty, don't draw circle around number
% Top left is (0,0) in our drawing
\newcommand{\domino}[5]{%
  \coordinate (topl) at ($ (#2*\cardwd-\cardwd, \cardht-#1*\cardht) $);
  \coordinate (botr) at ($ (#2*\cardwd, -#1*\cardht) $);
  \coordinate (botl) at (topl |- botr);
  \coordinate (topr) at (topl -| botr);
  \coordinate (topm) at ($ (topl)!0.5!(topr) $);
  \coordinate (botm) at ($ (botl)!0.5!(botr) $);

  \makestyles\stylea\contenta{#4}
  \makestyles\styleb\contentb{#5}

  \draw (topl) rectangle (botr);
  \draw [divider] (topm) -- (botm);

  \node[text width=\cardtxtwd,align=flush center,\stylea] at
     ($ (topl)!0.5!(botm) $) {\contenta\par};
  \node[text width=\cardtxtwd,align=flush center,\styleb] at
     ($ (topm)!0.5!(botr) $) {\contentb\par};
  \def\templabel{#3}
  \ifx\templabel\empty
  \else
    \node[circle,draw,thin,inner sep=1pt,fill=white]
      at ($ (topl)!0.5!(botr) $) {#3};
  \fi

  \ifx\cardtitle\empty
  \else
    \node[fill=white] at ($ (topl)!0.5!(topr) + (0,-\offset) $) {\cardtitle};
  \fi
}

\setlength{\parindent}{0pt}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 
